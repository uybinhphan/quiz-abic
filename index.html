<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în ki·ªÉm tra nghi·ªáp v·ª•</title>
    <style>
        * { /* Apply border-box universally */
            box-sizing: border-box;
        }
        /* --- COLOR VARIABLES --- */
        :root {
            /* Light Theme (Default) */
            --bg-color: #f8f9fa; --text-color: #212529; --card-bg-color: #ffffff;
            --card-border-color: #dee2e6; --primary-color: #007bff; --secondary-color: #6c757d;
            --success-color: #28a745; --danger-color: #dc3545; --warning-color: #ffc107;
            --info-color: #17a2b8; --timer-color: var(--primary-color); --disabled-bg-color: #e9ecef;
            --disabled-text-color: #6c757d; --button-default-bg: #ffffff; --button-default-text: var(--text-color);
            --button-default-border: var(--card-border-color); --button-hover-bg: #e9ecef;
            --success-feedback-bg: #d4edda; --success-feedback-text: #155724;
            --danger-feedback-bg: #f8d7da; --danger-feedback-text: #721c24;
            --source-bg: #e2e3e5; --source-text: var(--secondary-color); --shadow-color: rgba(0, 0, 0, 0.1);
            --theme-toggle-icon: '‚òÄÔ∏è'; --settings-icon: '‚öôÔ∏è';
            --menu-bg: var(--card-bg-color); --menu-border: var(--card-border-color);
            --app-padding: 30px; --app-padding-mobile: 15px;
            --timer-duration: 0.5s; /* Default CSS duration, JS overrides this */
            --filter-active-color: var(--danger-color); /* Color for active filter button */
        }
        body.dark-theme {
             /* Dark Theme Overrides */
            --bg-color: #121212; --text-color: #e0e0e0; --card-bg-color: #1e1e1e;
            --card-border-color: #444444; --primary-color: #58a6ff; --secondary-color: #8b949e;
            --success-color: #56d364; --danger-color: #f85149; --warning-color: #e3b341;
            --info-color: #79c0ff; --timer-color: var(--primary-color); --disabled-bg-color: #30363d;
            --disabled-text-color: #8b949e; --button-default-bg: #21262d; --button-default-text: var(--text-color);
            --button-default-border: #30363d; --button-hover-bg: #30363d;
            --success-feedback-bg: #2ea043; --success-feedback-text: #ffffff;
            --danger-feedback-bg: #d73a49; --danger-feedback-text: #ffffff;
            --source-bg: #21262d; --source-text: var(--secondary-color); --shadow-color: rgba(0, 0, 0, 0.4);
            --theme-toggle-icon: 'üåô'; --settings-icon: '‚öôÔ∏è';
            --menu-bg: #2a2a2a; --menu-border: #555555;
             --filter-active-color: var(--danger-color);
        }

        /* --- BASE STYLES --- */
         body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }
         #app { background-color: var(--card-bg-color); padding: var(--app-padding); border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-color); width: 100%; max-width: 700px; text-align: center; border: 1px solid var(--card-border-color); transition: background-color 0.3s ease, border-color 0.3s ease; position: relative; }
         /* Adjusted Title Margins */
         h1 { color: var(--primary-color); margin-bottom: 0.5em; }
         h2 { color: var(--primary-color); margin-bottom: 0.5em; }
         #quiz-title {
            font-size: 1.1em; color: var(--secondary-color);
            margin-top: -0.25em; margin-bottom: 1.5em;
            font-weight: normal;
         }

         /* --- HOW TO USE SECTION --- */
         #usage-details { margin-bottom: 20px; text-align: left; border: 1px dashed var(--secondary-color); border-radius: 5px; background-color: var(--bg-color); transition: all 0.3s ease-out; opacity: 1; max-height: 1000px; overflow: hidden;}
         #usage-details.hidden { opacity: 0; pointer-events: none; margin-bottom: 0; border: none; padding-top: 0; padding-bottom: 0; max-height: 0; }
         #usage-details summary { padding: 10px 15px; font-weight: bold; cursor: pointer; color: var(--primary-color); }
         #usage-details summary:hover { background-color: var(--button-hover-bg); }
         #usage-details div { padding: 0 15px 15px 15px; font-size: 0.9em; color: var(--secondary-color); }
         #usage-details code { background-color: var(--source-bg); padding: 2px 4px; border-radius: 3px; font-family: monospace; color: var(--text-color);}

         /* --- SELECT SECTION --- */
         #select-section {
            margin-bottom: 30px; padding: 20px; border: 1px solid var(--card-border-color); border-radius: 8px;
            background-color: var(--bg-color); text-align: left; transition: background-color 0.3s ease, border-color 0.3s ease;
         }
         #quiz-file-list {
            display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; min-height: 30px;
         }
         .quiz-file-button {
             padding: 10px 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; text-align: left; font-size: 1em; word-break: break-word;
         }
         .quiz-file-button:hover { filter: brightness(1.1); }
         .quiz-file-button:disabled { background-color: var(--disabled-bg-color); color: var(--disabled-text-color); cursor: not-allowed; opacity: 0.6; }

         #status-message {
             display: block; margin-top: 5px; margin-bottom: 15px; color: var(--secondary-color); font-style: italic; min-height: 1.2em;
         }
         #shuffle-option { margin-top: 15px; margin-bottom: 15px; }
         #shuffle-option label { margin-left: 8px; cursor: pointer; color: var(--secondary-color); font-weight: normal; }
         #shuffle-checkbox { vertical-align: middle; cursor: pointer; filter: invert(var(--is-dark, 0)); }
         body.dark-theme #shuffle-checkbox { --is-dark: 1; }

         /* --- QUIZ SECTION --- */
         #quiz-section { display: none; text-align: left; }
         #auto-advance-timer-bar { height: 5px; background-color: var(--disabled-bg-color); border-radius: 0; overflow: hidden; display: none; transition: background-color 0.3s ease; --timer-duration: 0.5s; }
         #auto-advance-timer-bar::after { content: ""; display: block; height: 100%; width: 0%; background-color: var(--timer-color); border-radius: 0; animation: none; transition: background-color 0.3s ease; }
         #auto-advance-timer-bar.timer-active { display: block; }
         #auto-advance-timer-bar.timer-active::after { width: 100%; animation-name: countdown; animation-duration: var(--timer-duration); animation-timing-function: linear; animation-fill-mode: forwards; }
         @keyframes countdown { from { width: 100%; } to { width: 0%; } }
         #quiz-header { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; padding: 0 var(--app-padding-mobile); }
         #progress { font-size: 0.9em; color: var(--secondary-color); font-weight: bold; flex-shrink: 0; }
         #jump-nav { display: flex; align-items: center; gap: 5px; font-size: 0.9em; }
         #jump-nav label { color: var(--secondary-color); }
         #jump-to-input { width: 60px; padding: 4px 6px; border: 1px solid var(--card-border-color); border-radius: 4px; font-size: 0.95em; text-align: center; background-color: var(--button-default-bg); color: var(--text-color); }
         #jump-to-input::-webkit-outer-spin-button, #jump-to-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
         #jump-to-input[type=number] { -moz-appearance: textfield; }
         #jump-to-btn { padding: 4px 10px; font-size: 0.9em; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease; }
         #jump-to-btn:hover { filter: brightness(1.1); }
         #score { font-size: 1.1em; font-weight: bold; color: var(--primary-color); flex-shrink: 0; }
         #settings-btn { background: none; border: none; font-size: 1.6em; cursor: pointer; padding: 0 5px; line-height: 1; color: var(--text-color); order: 5; transition: opacity 0.2s ease; }
         #settings-btn:disabled { opacity: 0.5; cursor: not-allowed; }
         #settings-btn::after { content: var(--settings-icon); }
         /* Adjusted Settings Menu Position - REMOVED 'top' */
         #settings-menu {
             display: none; position: absolute;
             /* top is set dynamically by JS */
             right: var(--app-padding-mobile);
             background-color: var(--menu-bg); border: 1px solid var(--menu-border);
             border-radius: 6px; padding: 15px; box-shadow: 0 4px 12px var(--shadow-color);
             z-index: 10; min-width: 200px;
             transition: background-color 0.3s ease, border-color 0.3s ease;
         }
         #settings-menu.menu-active { display: block; }
         .settings-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
         .settings-item label { font-size: 0.95em; color: var(--text-color); margin-right: 10px; }
         .settings-item:last-child { margin-bottom: 0; }
         #timer-control { display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: var(--secondary-color); }
         #timer-control button { font-size: 1.1em; line-height: 1; padding: 2px 8px; min-width: 25px; cursor: pointer; border: 1px solid var(--button-default-border); background-color: var(--button-default-bg); color: var(--secondary-color); border-radius: 4px; transition: background-color 0.2s ease, border-color 0.2s ease; }
         #timer-control button:hover:not(:disabled) { background-color: var(--button-hover-bg); }
         #timer-control button:disabled { background-color: var(--disabled-bg-color); color: var(--disabled-text-color); cursor: not-allowed; opacity: 0.6;}
         #timer-duration-display { font-weight: bold; min-width: 35px; text-align: center; color: var(--text-color); }
         #theme-toggle-btn { background-color: var(--button-default-bg); border: 1px solid var(--button-default-border); font-size: 1.1em; color: var(--text-color); padding: 4px 10px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; }
         #theme-toggle-btn:hover { background-color: var(--button-hover-bg); }
         #theme-toggle-btn::after { content: var(--theme-toggle-icon); margin-left: 5px; }
         #question-container { background-color: var(--bg-color); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--card-border-color); margin-left: var(--app-padding-mobile); margin-right: var(--app-padding-mobile); transition: background-color 0.3s ease, border-color 0.3s ease; }
         #question-text { font-size: 1.4em; margin-bottom: 20px; color: var(--text-color); line-height: 1.4; white-space: pre-wrap; word-break: break-word;}
         #answers { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px; }
         .answer-btn { display: block; width: 100%; padding: 12px 15px; background-color: var(--button-default-bg); border: 1px solid var(--button-default-border); border-radius: 5px; text-align: left; font-size: 1em; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease; color: var(--text-color); white-space: pre-wrap; min-height: calc(1.6em + 24px); word-break: break-word;}
         .answer-btn:hover:not(:disabled) { background-color: var(--button-hover-bg); border-color: var(--secondary-color); }
         .answer-btn:disabled { cursor: not-allowed; background-color: var(--disabled-bg-color); color: var(--disabled-text-color); border-color: var(--card-border-color); opacity: 0.7; }
         .answer-btn.selected { border-width: 2px; font-weight: bold; }
         .answer-btn.correct { background-color: var(--success-color) !important; border-color: var(--success-color) !important; color: white !important; filter: brightness(0.9); }
         .answer-btn.incorrect { background-color: var(--danger-color) !important; border-color: var(--danger-color) !important; color: white !important; filter: brightness(0.9); }
         .answer-btn.reveal-correct { background-color: var(--success-feedback-bg) !important; border-color: var(--success-color) !important; color: var(--success-feedback-text) !important; font-weight: bold; }
         body.dark-theme .answer-btn.reveal-correct { background-color: #2ea043 !important; border-color: #56d364 !important; color: white !important; }
         #source { margin-top: 15px; padding: 10px; border-radius: 5px; font-size: 0.95em; min-height: 1.5em; margin-left: var(--app-padding-mobile); margin-right: var(--app-padding-mobile); background-color: var(--source-bg); color: var(--source-text); border: 1px solid var(--card-border-color); font-style: italic; display: none; white-space: pre-wrap; margin-bottom: 15px; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; word-break: break-word;}

         /* --- NAVIGATION AREA --- */
         #navigation { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; padding: 0 var(--app-padding-mobile) 10px; }
         #nav-controls { display: flex; gap: 10px; margin-right: auto; flex-wrap: wrap; }
         #review-controls { display: flex; gap: 10px; margin-right: auto; flex-wrap: wrap;}
         #exit-review-btn { background-color: var(--warning-color); color: #212529; }
         body.dark-theme #exit-review-btn { color: #121212; }
         #toggle-filter-btn { background-color: var(--info-color); color: white; }
         #toggle-filter-btn.filter-active { background-color: var(--filter-active-color); font-weight: bold;}
         #nav-prev-next { display: flex; gap: 10px; margin-left: auto; }
         .nav-btn { padding: 10px 15px; font-size: 0.9em; border: none; border-radius: 5px; cursor: pointer; background-color: var(--secondary-color); color: white; transition: background-color 0.3s ease; white-space: nowrap; }
         .nav-btn:hover:not(:disabled) { filter: brightness(1.1); }
         .nav-btn:disabled { background-color: var(--disabled-bg-color); color: var(--disabled-text-color); cursor: not-allowed; opacity: 0.6; }
         #restart-practice-btn { background-color: var(--warning-color); color: #212529; }
         body.dark-theme #restart-practice-btn { color: #121212; }
         #restart-practice-btn:hover:not(:disabled) { filter: brightness(1.1); }
         #shuffle-now-btn { background-color: var(--info-color); color: white; }
         #shuffle-now-btn:hover:not(:disabled) { filter: brightness(1.1); }
         #reload-original-btn { background-color: var(--secondary-color); color: white; }
         #reload-original-btn:hover:not(:disabled) { filter: brightness(1.1); }
         #back-to-select-quiz-btn { background-color: var(--secondary-color); }
         #back-to-select-quiz-btn:hover:not(:disabled) { filter: brightness(1.1); }

         /* --- RESULTS SECTION --- */
         #results-section { display: none; text-align: center; padding: 30px var(--app-padding-mobile); background-color: var(--bg-color); border-radius: 8px; border: 1px solid var(--card-border-color); transition: background-color 0.3s ease, border-color 0.3s ease; }
         #final-score { font-size: 1.8em; color: var(--success-color); margin-bottom: 25px; }
         #results-controls { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
         #restart-btn, #review-btn, #back-to-select-btn {
             padding: 12px 25px; font-size: 1.1em; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease;
         }
         #restart-btn { background-color: var(--primary-color); color: white; }
         #review-btn { background-color: var(--success-color); color: white; }
         #back-to-select-btn { background-color: var(--secondary-color); color: white; margin-top: 10px; }
         #restart-btn:hover, #review-btn:hover, #back-to-select-btn:hover { filter: brightness(1.1); }

         /* --- UTILITY CLASSES --- */
         #error-message { color: var(--danger-color); margin-top: 15px; font-weight: bold; padding: 0 var(--app-padding-mobile); min-height: 1.2em; }
         .hidden { display: none !important; }

         /* --- RESPONSIVE DESIGN (Standard CSS Media Query) --- */
         @media (max-width: 700px) {
             body {
                 padding: 0;
             }
             #app {
                 padding: 0; box-shadow: none; border-radius: 0; max-width: 100%; border: none;
             }
             h1 { font-size: 1.6em; }
             h2 { font-size: 1.4em; }
             #quiz-title {
                 font-size: 1em; margin-bottom: 1em;
                 padding: 0 var(--app-padding-mobile);
            }
             #usage-details {
                 border-radius: 0; border-left: none; border-right: none; margin-bottom: 10px;
             }
             #select-section {
                 padding: 20px var(--app-padding-mobile); margin-bottom: 15px; border-radius: 0; border-left: none; border-right: none;
             }
             #auto-advance-timer-bar {
                 margin-left: 0; margin-right: 0; border-radius: 0;
             }
             #quiz-header {
                 padding: 10px var(--app-padding-mobile); margin-top: 10px; margin-bottom: 10px; justify-content: space-between;
             }
             #question-container {
                 padding: 15px var(--app-padding-mobile); margin-left: 0; margin-right: 0; border-radius: 0; border-left: none; border-right: none; margin-bottom: 15px;
             }
             #source {
                 margin-left: 0; margin-right: 0; padding-left: var(--app-padding-mobile); padding-right: var(--app-padding-mobile); border-radius: 0; border-left: none; border-right: none;
             }
             #navigation {
                 padding: 15px var(--app-padding-mobile) 10px; justify-content: center;
             }
             #nav-controls, #review-controls {
                 order: -1; margin-right: 0; width: 100%; justify-content: center; margin-bottom: 10px;
             }
             #nav-prev-next {
                 margin-left: 0; width: 100%; justify-content: space-between;
             }
             #results-section {
                 padding: 20px var(--app-padding-mobile); border-radius: 0; border-left: none; border-right: none;
             }
             #question-text { font-size: 1.1em; }
             .answer-btn { font-size: 0.9em; }
             .nav-btn { font-size: 0.85em; padding: 8px 12px; }
             /* Adjusted Settings Menu Position (Mobile) - REMOVED 'top' */
             #settings-menu {
                 right: 5px;
                 /* top is set dynamically by JS */
             }
             #results-controls {
                 flex-direction: column; gap: 10px; align-items: center;
             }
             #restart-btn, #review-btn, #back-to-select-btn {
                 width: 80%; max-width: 300px;
             }
         }
         /* --- End of Media Query --- */

    </style>
</head>
<body class=""> <!-- Theme class managed by JS -->
    <div id="app">
        <h1>√în ki·ªÉm tra nghi·ªáp v·ª•</h1>
        <h2>ƒê·ª£t 1 - 2025</h2>
        <h2 id="quiz-title" class="hidden"></h2> <!-- Quiz Title -->

        <!-- How to Use Section -->
        <details id="usage-details" open>
            <summary>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</summary>
             <div>
                 <ol>
                     <li>Ch·ªçn m·ªôt b·ªô c√¢u h·ªèi t·ª´ danh s√°ch b√™n d∆∞·ªõi (t√™n b·ªô c√¢u h·ªèi l·∫•y t·ª´ t√™n file Excel g·ªëc).</li>
                     <li>(T√πy ch·ªçn) Tick "X√°o tr·ªôn" <i>tr∆∞·ªõc khi</i> ch·ªçn b·ªô c√¢u h·ªèi ƒë·ªÉ c√¢u h·ªèi hi·ªán ng·∫´u nhi√™n.</li>
                     <li>Quiz s·∫Ω b·∫Øt ƒë·∫ßu sau khi d·ªØ li·ªáu ƒë∆∞·ª£c t·∫£i.</li>
                     <li>Tr·∫£ l·ªùi b·∫±ng c√°ch nh·∫•n v√†o ƒë√°p √°n.</li>
                     <li>S·ª≠ d·ª•ng n√∫t "C√¢u tr∆∞·ªõc", "C√¢u sau", ho·∫∑c nh·∫≠p s·ªë c√¢u v√†o √¥ "ƒê·∫øn:" ƒë·ªÉ di chuy·ªÉn.</li>
                     <li>Nh·∫•n bi·ªÉu t∆∞·ª£ng ‚öôÔ∏è ƒë·ªÉ ch·ªânh t·ªëc ƒë·ªô t·ª± chuy·ªÉn c√¢u ho·∫∑c ƒë·ªïi giao di·ªán S√°ng/T·ªëi.</li>
                     <li>Khi ho√†n th√†nh, xem k·∫øt qu·∫£ v√† c√≥ th·ªÉ l√†m l·∫°i (b·ªô c√¢u h·ªèi hi·ªán t·∫°i), xem l·∫°i b√†i l√†m, ho·∫∑c quay l·∫°i ch·ªçn b·ªô c√¢u h·ªèi kh√°c.</li>
                 </ol>
             </div>
        </details>

        <!-- Select Section -->
        <div id="select-section">
             <h2>Ch·ªçn B·ªô C√¢u H·ªèi</h2>
             <div id="quiz-file-list">
                 <p>ƒêang t·∫£i danh s√°ch b·ªô c√¢u h·ªèi...</p>
             </div>
             <p id="status-message"></p>
             <div id="shuffle-option">
                 <input type="checkbox" id="shuffle-checkbox">
                 <label for="shuffle-checkbox">X√°o tr·ªôn c√¢u h·ªèi</label>
             </div>
             <p id="error-message" class="hidden"></p>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-section" class="hidden">
            <div id="auto-advance-timer-bar"></div>
            <div id="quiz-header">
                 <div id="progress">C√¢u 1 / 10</div>
                 <div id="jump-nav">
                     <label for="jump-to-input" id="jump-label">ƒê·∫øn:</label>
                     <input type="number" id="jump-to-input" min="1">
                     <button id="jump-to-btn">ƒêi</button>
                 </div>
                 <div id="score">ƒêi·ªÉm: 0</div>
                 <button id="settings-btn" title="C√†i ƒë·∫∑t"></button>
            </div>
             <div id="settings-menu" class="hidden">
                <!-- Settings Items -->
                <div class="settings-item">
                    <label>T·ª± chuy·ªÉn (gi√¢y):</label>
                    <div id="timer-control">
                        <button id="timer-decrease-btn" title="Gi·∫£m">-</button>
                        <span id="timer-duration-display">0.5s</span>
                        <button id="timer-increase-btn" title="TƒÉng">+</button>
                    </div>
                </div>
                <div class="settings-item">
                    <label>Giao di·ªán:</label>
                    <button id="theme-toggle-btn"></button>
                </div>
            </div>
            <div id="question-container">
                <h2 id="question-text">...</h2>
                <div id="answers"></div>
            </div>
            <div id="source" class="hidden">...</div>
            <div id="navigation">
                <div id="nav-controls" class="hidden"> <!-- Contains buttons for during quiz -->
                    <button id="restart-practice-btn" class="nav-btn">L√†m l·∫°i</button>
                    <button id="shuffle-now-btn" class="nav-btn">X√°o tr·ªôn</button>
                    <button id="reload-original-btn" class="nav-btn">Th·ª© t·ª± g·ªëc</button>
                    <button id="back-to-select-quiz-btn" class="nav-btn">Ch·ªçn b·ªô kh√°c</button> <!-- Back to selection -->
                </div>
                <div id="review-controls" class="hidden"> <!-- Contains buttons for review mode -->
                    <button id="exit-review-btn" class="nav-btn">Tho√°t xem l·∫°i</button>
                    <button id="toggle-filter-btn" class="nav-btn">Ch·ªâ xem c√¢u sai</button>
                </div>
                <div id="nav-prev-next"> <!-- Contains Prev/Next buttons -->
                    <button id="prev-btn" class="nav-btn">C√¢u tr∆∞·ªõc</button>
                    <button id="next-btn" class="nav-btn">C√¢u sau</button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
             <h2>K·∫øt qu·∫£ Quiz</h2>
             <p id="final-score">ƒêi·ªÉm s·ªë cu·ªëi c√πng: 0 / 0</p>
             <div id="results-controls">
                <button id="restart-btn">L√†m l·∫°i Quiz (B·ªô n√†y)</button>
                <button id="review-btn">Xem l·∫°i b√†i l√†m</button>
                <button id="back-to-select-btn">Ch·ªçn b·ªô c√¢u h·ªèi kh√°c</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const bodyElement = document.body;
        const quizTitleElement = document.getElementById('quiz-title');
        const usageDetails = document.getElementById('usage-details');
        const selectSection = document.getElementById('select-section');
        const quizFileListContainer = document.getElementById('quiz-file-list');
        const statusMessage = document.getElementById('status-message');
        const shuffleCheckbox = document.getElementById('shuffle-checkbox');
        const quizSection = document.getElementById('quiz-section');
        const resultsSection = document.getElementById('results-section');
        const questionText = document.getElementById('question-text');
        const answersContainer = document.getElementById('answers');
        const sourceDiv = document.getElementById('source');
        const timerBar = document.getElementById('auto-advance-timer-bar');
        const progressText = document.getElementById('progress');
        const scoreText = document.getElementById('score');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const navControls = document.getElementById('nav-controls');
        const reviewControls = document.getElementById('review-controls');
        const restartPracticeBtn = document.getElementById('restart-practice-btn');
        const shuffleNowBtn = document.getElementById('shuffle-now-btn');
        const reloadOriginalBtn = document.getElementById('reload-original-btn');
        const backToSelectQuizBtn = document.getElementById('back-to-select-quiz-btn'); // Added reference
        const exitReviewBtn = document.getElementById('exit-review-btn');
        const toggleFilterBtn = document.getElementById('toggle-filter-btn');
        const finalScoreText = document.getElementById('final-score');
        const restartBtn = document.getElementById('restart-btn');
        const reviewBtn = document.getElementById('review-btn');
        const backToSelectBtn = document.getElementById('back-to-select-btn'); // From results screen
        const errorMessage = document.getElementById('error-message');
        const jumpNav = document.getElementById('jump-nav');
        const jumpLabel = document.getElementById('jump-label');
        const jumpToInput = document.getElementById('jump-to-input');
        const jumpToBtn = document.getElementById('jump-to-btn');
        const timerDecreaseBtn = document.getElementById('timer-decrease-btn');
        const timerIncreaseBtn = document.getElementById('timer-increase-btn');
        const timerDurationDisplay = document.getElementById('timer-duration-display');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const themeToggleButton = document.getElementById('theme-toggle-btn');

        // --- Quiz State Variables ---
        let originalQuizData = [];
        let quizData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let userAnswers = {};
        let questionsAnswered = {};
        let autoAdvanceTimer = null;
        let autoAdvanceDuration = 500;
        const TIMER_STEP = 100;
        const MIN_TIMER = 500;
        const MAX_TIMER = 5000;
        let isReviewMode = false;
        let reviewWrongOnly = false;
        let wrongAnswerIndices = [];
        let currentWrongAnswerReviewIndex = 0;
        let currentFileName = "";
        const MANIFEST_PATH = 'data/quiz_manifest.json';

        // --- THEME FUNCTIONS ---
        function applyInitialTheme() { const savedTheme = localStorage.getItem('theme'); if (savedTheme === 'dark') { bodyElement.classList.add('dark-theme'); } else { bodyElement.classList.remove('dark-theme'); } updateThemeToggleButton(); }
        function toggleTheme() { bodyElement.classList.toggle('dark-theme'); const isDark = bodyElement.classList.contains('dark-theme'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); updateThemeToggleButton(); }
        function updateThemeToggleButton() { /* Icon handled by CSS */ }

        // --- SETTINGS MENU FUNCTIONS ---
        function toggleSettingsMenu() {
            settingsMenu.classList.toggle('menu-active');
            settingsMenu.classList.toggle('hidden');

            if (settingsMenu.classList.contains('menu-active')) {
                // Calculate position dynamically when showing the menu
                try {
                    const btnRect = settingsBtn.getBoundingClientRect();
                    const appRect = document.getElementById('app').getBoundingClientRect(); // Get app container bounds

                    // Calculate the desired top position for the menu:
                    // (button's top relative to viewport - app's top relative to viewport) = button's top relative to app
                    // Add the button's height to position below it
                    // Add a small gap (e.g., 5px)
                    const menuTop = (btnRect.top - appRect.top) + btnRect.height + 5; // 5px gap below button

                    settingsMenu.style.top = `${menuTop}px`;

                    // Optional: Prevent menu going off-screen vertically (basic example)
                    const menuRect = settingsMenu.getBoundingClientRect();
                    if (menuRect.bottom > window.innerHeight) {
                         // If menu bottom is below viewport, adjust top
                         const newTop = menuTop - (menuRect.bottom - window.innerHeight) - 10; // Move up slightly more than needed
                         settingsMenu.style.top = `${Math.max(0, newTop)}px`; // Ensure it doesn't go above app top
                    }

                } catch (e) {
                    console.error("Error calculating menu position:", e);
                    // Fallback positioning if calculation fails? Or just rely on default flow?
                    // settingsMenu.style.top = '60px'; // Simple fallback
                }
            }
             // No need to reset 'top' when hiding, as it's recalculated on show
        }
        // Listener to close menu when clicking outside
        document.addEventListener('click', function(event) {
            if (settingsMenu.classList.contains('menu-active') &&
                !settingsMenu.contains(event.target) &&
                !settingsBtn.contains(event.target))
            {
                settingsMenu.classList.remove('menu-active');
                settingsMenu.classList.add('hidden');
            }
        });

        // --- Event Listeners ---
        settingsBtn.addEventListener('click', toggleSettingsMenu);
        themeToggleButton.addEventListener('click', toggleTheme);
        prevBtn.addEventListener('click', navigatePrevious);
        nextBtn.addEventListener('click', navigateNext);
        restartPracticeBtn.addEventListener('click', restartQuiz);
        shuffleNowBtn.addEventListener('click', handleShuffleNow);
        reloadOriginalBtn.addEventListener('click', handleReloadOriginal);
        backToSelectQuizBtn.addEventListener('click', showSelectScreen); // Added listener for quiz screen button
        restartBtn.addEventListener('click', restartQuiz);
        reviewBtn.addEventListener('click', startReviewMode);
        backToSelectBtn.addEventListener('click', showSelectScreen); // Listener for results screen button
        exitReviewBtn.addEventListener('click', exitReviewMode);
        toggleFilterBtn.addEventListener('click', toggleReviewFilter);
        jumpToBtn.addEventListener('click', handleJumpToQuestion);
        jumpToInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') { event.preventDefault(); handleJumpToQuestion(); } });
        answersContainer.addEventListener('click', (event) => { if (event.target.classList.contains('answer-btn') && !event.target.disabled) { handleAnswerSelection(event.target); } });
        timerDecreaseBtn.addEventListener('click', decreaseTimer);
        timerIncreaseBtn.addEventListener('click', increaseTimer);

        // --- Core Quiz Functions ---
        // (decreaseTimer, increaseTimer, updateTimerDisplayAndControls, clearAutoAdvanceTimer,
        // navigatePrevious, navigateNext, handleJumpToQuestion, handleShuffleNow,
        // handleReloadOriginal, shuffleArray remain unchanged)
        function decreaseTimer() { if (!isReviewMode && autoAdvanceDuration > MIN_TIMER) { autoAdvanceDuration -= TIMER_STEP; updateTimerDisplayAndControls(); } }
        function increaseTimer() { if (!isReviewMode && autoAdvanceDuration < MAX_TIMER) { autoAdvanceDuration += TIMER_STEP; updateTimerDisplayAndControls(); } }
        function updateTimerDisplayAndControls() { timerDurationDisplay.textContent = (autoAdvanceDuration / 1000).toFixed(1) + 's'; timerDecreaseBtn.disabled = isReviewMode || autoAdvanceDuration <= MIN_TIMER; timerIncreaseBtn.disabled = isReviewMode || autoAdvanceDuration >= MAX_TIMER; timerBar.style.setProperty('--timer-duration', autoAdvanceDuration + 'ms'); }
        function clearAutoAdvanceTimer() { if (autoAdvanceTimer) { clearTimeout(autoAdvanceTimer); autoAdvanceTimer = null; } timerBar.classList.remove('timer-active'); timerBar.style.animation = 'none'; void timerBar.offsetWidth; /* trigger reflow */ timerBar.style.animation = null; }
        function navigatePrevious() { clearAutoAdvanceTimer(); if (reviewWrongOnly) { if (currentWrongAnswerReviewIndex > 0) { currentWrongAnswerReviewIndex--; currentQuestionIndex = wrongAnswerIndices[currentWrongAnswerReviewIndex]; displayQuestion(currentQuestionIndex); } } else { if (currentQuestionIndex > 0) { currentQuestionIndex--; displayQuestion(currentQuestionIndex); } } }
        function navigateNext() { clearAutoAdvanceTimer(); if (reviewWrongOnly) { if (currentWrongAnswerReviewIndex < wrongAnswerIndices.length - 1) { currentWrongAnswerReviewIndex++; currentQuestionIndex = wrongAnswerIndices[currentWrongAnswerReviewIndex]; displayQuestion(currentQuestionIndex); } } else { if (currentQuestionIndex < quizData.length - 1) { currentQuestionIndex++; displayQuestion(currentQuestionIndex); } else if (!isReviewMode) { showResults(); } } }
        function handleJumpToQuestion() { if (!quizData || quizData.length === 0) return; const targetNum = parseInt(jumpToInput.value, 10); let maxQuestions, targetIndex; if (reviewWrongOnly) { maxQuestions = wrongAnswerIndices.length; if (isNaN(targetNum) || targetNum < 1 || targetNum > maxQuestions) { alert(`Vui l√≤ng nh·∫≠p s·ªë th·ª© t·ª± c√¢u sai h·ª£p l·ªá t·ª´ 1 ƒë·∫øn ${maxQuestions}.`); } else { currentWrongAnswerReviewIndex = targetNum - 1; targetIndex = wrongAnswerIndices[currentWrongAnswerReviewIndex]; if (targetIndex !== currentQuestionIndex) { clearAutoAdvanceTimer(); currentQuestionIndex = targetIndex; displayQuestion(currentQuestionIndex); } } } else { maxQuestions = quizData.length; if (isNaN(targetNum) || targetNum < 1 || targetNum > maxQuestions) { alert(`Vui l√≤ng nh·∫≠p s·ªë c√¢u h·ª£p l·ªá t·ª´ 1 ƒë·∫øn ${maxQuestions}.`); } else { targetIndex = targetNum - 1; if (targetIndex !== currentQuestionIndex) { clearAutoAdvanceTimer(); currentQuestionIndex = targetIndex; displayQuestion(currentQuestionIndex); } } } jumpToInput.value = ''; }
        function handleShuffleNow() { if (isReviewMode || !quizData || quizData.length === 0) return; console.log("[Action] Shuffling current questions..."); shuffleArray(quizData); restartQuiz(); }
        function handleReloadOriginal() { if (isReviewMode || !originalQuizData || originalQuizData.length === 0) { alert("Kh√¥ng c√≥ d·ªØ li·ªáu g·ªëc ƒë·ªÉ t·∫£i l·∫°i."); return; } console.log("[Action] Reloading original question order..."); quizData = [...originalQuizData]; restartQuiz(); }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }


        // --- JSON Loading Logic ---
        // (loadQuizManifest, displayQuizOptions, loadQuizFromJson remain unchanged)
         function loadQuizManifest() {
            console.log(`[Manifest] Fetching quiz manifest from ${MANIFEST_PATH}...`);
            hideError();
            quizFileListContainer.innerHTML = '<p>ƒêang t·∫£i danh s√°ch b·ªô c√¢u h·ªèi...</p>';
            statusMessage.textContent = "";
            shuffleCheckbox.disabled = true;
            const cacheBuster = `?t=${new Date().getTime()}`;

            fetch(MANIFEST_PATH + cacheBuster)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) { throw new Error(`Kh√¥ng t√¨m th·∫•y t·ªáp k√™ khai ${MANIFEST_PATH}. H√£y ch·∫°y script \`node convert.js\` v√† ƒë·∫£m b·∫£o t·ªáp ƒë∆∞·ª£c ƒë·∫©y l√™n GitHub.`); }
                        else { throw new Error(`L·ªói m·∫°ng khi t·∫£i ${MANIFEST_PATH} (${response.status}): ${response.statusText}`); }
                    }
                    return response.json();
                })
                .then(quizList => {
                    console.log("[Manifest] Success, received:", quizList);
                    displayQuizOptions(quizList);
                })
                .catch(error => {
                    console.error("[Manifest Error]", error);
                    showError(`Kh√¥ng th·ªÉ t·∫£i danh s√°ch b·ªô c√¢u h·ªèi: ${error.message}`);
                    quizFileListContainer.innerHTML = '';
                    statusMessage.textContent = "L·ªói t·∫£i danh s√°ch.";
                });
        }

        function displayQuizOptions(quizList) {
            console.log("[UI] Displaying quiz options...");
            hideError();
            quizFileListContainer.innerHTML = '';
            statusMessage.textContent = "Vui l√≤ng ch·ªçn m·ªôt b·ªô c√¢u h·ªèi.";

            if (!quizList || !Array.isArray(quizList)) { showError("D·ªØ li·ªáu danh s√°ch b·ªô c√¢u h·ªèi kh√¥ng h·ª£p l·ªá."); return; }
            if (quizList.length === 0) { showError("Kh√¥ng t√¨m th·∫•y b·ªô c√¢u h·ªèi n√†o trong t·ªáp k√™ khai."); return; }

            quizList.forEach(quiz => {
                if (!quiz || typeof quiz.name !== 'string' || typeof quiz.file !== 'string') { console.warn("Skipping invalid entry in manifest:", quiz); return; }
                const btn = document.createElement('button');
                btn.classList.add('quiz-file-button');
                btn.textContent = quiz.name;
                btn.dataset.quizFile = quiz.file;
                btn.dataset.quizName = quiz.name;
                btn.addEventListener('click', () => loadQuizFromJson(quiz.file, quiz.name));
                quizFileListContainer.appendChild(btn);
            });
            shuffleCheckbox.disabled = false;
            quizFileListContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
        }

        function loadQuizFromJson(jsonFilePath, quizName) {
            console.log(`[Fetch] Requesting data for quiz: ${quizName} from ${jsonFilePath}`);
            hideError();
            statusMessage.textContent = `ƒêang t·∫£i d·ªØ li·ªáu cho "${quizName}"...`;
            quizFileListContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);
            shuffleCheckbox.disabled = true;
            currentFileName = quizName;

            quizTitleElement.textContent = quizName;
            quizTitleElement.classList.remove('hidden');

            const cacheBuster = `?t=${new Date().getTime()}`;

            fetch(jsonFilePath + cacheBuster)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) { throw new Error(`Kh√¥ng t√¨m th·∫•y t·ªáp ${jsonFilePath}.`); }
                        else { throw new Error(`L·ªói m·∫°ng (${response.status}): ${response.statusText}`); }
                    }
                    return response.json();
                })
                .then(jsonData => {
                    console.log("[Fetch Success] Received JSON data.");
                    processQuizData(jsonData);
                })
                .catch(error => {
                    console.error("[Fetch Error]", error);
                    showError(`L·ªói t·∫£i d·ªØ li·ªáu cho "${quizName}": ${error.message}`);
                    showSelectScreen();
                });
        }


        // --- Data Processing and Quiz Start ---
        // (processQuizData remains unchanged)
        function processQuizData(jsonData) {
             console.log(`[Processing] Processing ${jsonData.length} questions from JSON for "${currentFileName}".`);
             try {
                 if (!Array.isArray(jsonData)) { throw new Error("D·ªØ li·ªáu t·∫£i v·ªÅ kh√¥ng ph·∫£i l√† m·ªôt m·∫£ng c√¢u h·ªèi h·ª£p l·ªá."); }
                 if (jsonData.length > 0) {
                     const firstQ = jsonData[0];
                     if (typeof firstQ.question !== 'string' || !Array.isArray(firstQ.options) || typeof firstQ.correctAnswerIndex !== 'number') {
                         console.warn("[Processing] D·ªØ li·ªáu JSON c√≥ v·∫ª kh√¥ng ƒë√∫ng c·∫•u tr√∫c mong ƒë·ª£i:", firstQ);
                     }
                     originalQuizData = [...jsonData];
                     quizData = [...jsonData];
                     if (shuffleCheckbox.checked) {
                         console.log("[Quiz Prep] Shuffling enabled. Shuffling...");
                         shuffleArray(quizData);
                     }
                     statusMessage.textContent = `ƒê√£ t·∫£i: ${currentFileName} (${quizData.length} c√¢u)`;
                     usageDetails.classList.add('hidden');
                     selectSection.classList.add('hidden');
                     selectSection.style.display = 'none';
                     startQuiz();
                 } else {
                     throw new Error(`T·ªáp c√¢u h·ªèi JSON cho "${currentFileName}" kh√¥ng ch·ª©a c√¢u h·ªèi h·ª£p l·ªá n√†o.`);
                 }
             } catch (error) {
                 console.error("[Error Handler] Error during JSON processing:", error);
                 showError(`L·ªói x·ª≠ l√Ω d·ªØ li·ªáu c√¢u h·ªèi: ${error.message}.`);
                 showSelectScreen();
             }
         }

        // --- Quiz Start and Display Functions ---
        // (startQuiz remains unchanged)
        function startQuiz() {
            console.log("[Mode] Starting Quiz (Normal Mode)");
            isReviewMode = false; reviewWrongOnly = false;
            currentQuestionIndex = 0; score = 0; userAnswers = {}; questionsAnswered = {};
            clearAutoAdvanceTimer(); hideError(); updateTimerDisplayAndControls();

            jumpToInput.max = (quizData && quizData.length > 0) ? quizData.length : 1;
            jumpToInput.value = '';
            jumpLabel.textContent = "ƒê·∫øn c√¢u:";

            resultsSection.classList.add('hidden'); resultsSection.style.display = 'none';
            quizSection.classList.remove('hidden'); quizSection.style.display = 'block';

            navControls.classList.remove('hidden'); // Show quiz nav controls
            reviewControls.classList.add('hidden'); // Hide review controls
            settingsBtn.disabled = false; settingsBtn.style.opacity = ''; settingsBtn.style.cursor = '';

            displayQuestion(currentQuestionIndex);
        }

        // (displayQuestion remains unchanged)
        function displayQuestion(index) {
             currentQuestionIndex = index;
             if (index < 0 || index >= quizData.length || !quizData[index]) {
                  console.error(`[Display Error] Invalid index ${index} or missing data. Quiz length: ${quizData.length}`);
                  showError(`L·ªói hi·ªÉn th·ªã c√¢u h·ªèi s·ªë ${index + 1}.`); return;
             }
             const currentQuestion = quizData[index];

             questionText.textContent = currentQuestion.question || "[L·ªói: Thi·∫øu c√¢u h·ªèi]";
             answersContainer.innerHTML = ''; sourceDiv.textContent = '';
             sourceDiv.classList.add('hidden'); sourceDiv.style.display = 'none';

             (currentQuestion.options || []).forEach((option, optionIndex) => {
                 const btn = document.createElement('button');
                 btn.classList.add('answer-btn');
                 btn.textContent = option || "(ƒê√°p √°n tr·ªëng)";
                 btn.dataset.index = optionIndex;
                 answersContainer.appendChild(btn);
             });

             scoreText.textContent = `ƒêi·ªÉm: ${score}`;

             if (isReviewMode) {
                  if (reviewWrongOnly) {
                      progressText.textContent = `C√¢u sai ${currentWrongAnswerReviewIndex + 1} / ${wrongAnswerIndices.length}`;
                      jumpLabel.textContent = "ƒê·∫øn c√¢u sai s·ªë:";
                      jumpToInput.max = wrongAnswerIndices.length || 1;
                      jumpToInput.placeholder = wrongAnswerIndices.length > 0 ? (currentWrongAnswerReviewIndex + 1).toString() : '0';
                  } else {
                      progressText.textContent = `Xem l·∫°i: C√¢u ${index + 1} / ${quizData.length}`;
                      jumpLabel.textContent = "ƒê·∫øn c√¢u:";
                      jumpToInput.max = quizData.length;
                      jumpToInput.placeholder = (index + 1).toString();
                  }
             } else {
                  progressText.textContent = `C√¢u ${index + 1} / ${quizData.length}`;
                  jumpLabel.textContent = "ƒê·∫øn c√¢u:";
                  jumpToInput.max = quizData.length;
                  jumpToInput.placeholder = (index + 1).toString();
             }
             restoreAnswerState(index);

             if (isReviewMode) {
                 answersContainer.querySelectorAll('.answer-btn').forEach(b => b.disabled = true);
                 navControls.classList.add('hidden');
                 reviewControls.classList.remove('hidden');
                 settingsBtn.disabled = true; settingsBtn.style.opacity = '0.5'; settingsBtn.style.cursor = 'not-allowed';
                 clearAutoAdvanceTimer(); timerBar.classList.remove('timer-active');
                 toggleFilterBtn.textContent = reviewWrongOnly ? "Xem t·∫•t c·∫£ c√¢u" : "Ch·ªâ xem c√¢u sai";
                 toggleFilterBtn.classList.toggle('filter-active', reviewWrongOnly);
                 toggleFilterBtn.disabled = wrongAnswerIndices.length === 0 && !reviewWrongOnly;
             } else {
                 navControls.classList.remove('hidden');
                 reviewControls.classList.add('hidden');
                 settingsBtn.disabled = false; settingsBtn.style.opacity = ''; settingsBtn.style.cursor = '';
                 updateTimerDisplayAndControls();
             }

             if (reviewWrongOnly) {
                  prevBtn.disabled = (currentWrongAnswerReviewIndex <= 0);
                  nextBtn.disabled = (currentWrongAnswerReviewIndex >= wrongAnswerIndices.length - 1);
                  nextBtn.textContent = 'C√¢u sau';
              } else {
                  prevBtn.disabled = (index <= 0);
                  const isLastQuestion = index === quizData.length - 1;
                  const isAnswered = questionsAnswered[index];
                  nextBtn.textContent = (isLastQuestion && !isReviewMode) ? 'Ho√†n th√†nh' : 'C√¢u sau';
                  nextBtn.disabled = (!isReviewMode && !isAnswered) || (isReviewMode && isLastQuestion);
              }
             settingsMenu.classList.remove('menu-active'); settingsMenu.classList.add('hidden'); // Ensure menu is closed on question change
        }

        // (restoreAnswerState remains unchanged)
        function restoreAnswerState(questionIndex) {
            const userAnswerIndex = userAnswers[questionIndex];
            const buttons = answersContainer.querySelectorAll('.answer-btn');
            const q = quizData[questionIndex];
            if (!q) return;
            const correctIdx = q.correctAnswerIndex;

            buttons.forEach(b => {
                b.disabled = isReviewMode || userAnswerIndex !== undefined;
                b.classList.remove('selected', 'correct', 'incorrect', 'reveal-correct');
            });

            if (userAnswerIndex !== undefined) {
                const selectedBtn = buttons[userAnswerIndex];
                if (selectedBtn) {
                    selectedBtn.classList.add('selected');
                    if (parseInt(userAnswerIndex, 10) === correctIdx) { selectedBtn.classList.add('correct'); }
                    else {
                        selectedBtn.classList.add('incorrect');
                        if (buttons[correctIdx]) { buttons[correctIdx].classList.add('reveal-correct'); }
                    }
                }
                sourceDiv.textContent = `Ngu·ªìn: ${q.source || 'N/A'}`;
                sourceDiv.classList.remove('hidden'); sourceDiv.style.display = 'block';
            } else {
                 sourceDiv.classList.add('hidden'); sourceDiv.style.display = 'none';
            }
        }

        // (handleAnswerSelection remains unchanged)
        function handleAnswerSelection(selectedButton) {
             if (isReviewMode || questionsAnswered[currentQuestionIndex]) return;
             clearAutoAdvanceTimer();
             const selectedIndex = parseInt(selectedButton.dataset.index, 10);
             const currentQuestion = quizData[currentQuestionIndex];
             if (!currentQuestion || typeof currentQuestion.correctAnswerIndex !== 'number') {
                 showError(`L·ªói d·ªØ li·ªáu cho c√¢u h·ªèi ${currentQuestionIndex + 1}.`); return;
             }
             const correctIndex = currentQuestion.correctAnswerIndex;
             userAnswers[currentQuestionIndex] = selectedIndex; questionsAnswered[currentQuestionIndex] = true;

             const allButtons = answersContainer.querySelectorAll('.answer-btn');
             allButtons.forEach(b => b.disabled = true);
             selectedButton.classList.add('selected');
             let isCorrect = (selectedIndex === correctIndex);

             if (isCorrect) { score++; selectedButton.classList.add('correct'); }
             else {
                 selectedButton.classList.add('incorrect');
                 if (allButtons[correctIndex]) { allButtons[correctIndex].classList.add('reveal-correct'); }
             }
             sourceDiv.textContent = `Ngu·ªìn: ${currentQuestion.source || 'N/A'}`;
             sourceDiv.classList.remove('hidden'); sourceDiv.style.display = 'block';
             scoreText.textContent = `ƒêi·ªÉm: ${score}`;
             nextBtn.disabled = false;

             if (currentQuestionIndex === quizData.length - 1) { nextBtn.textContent = 'Ho√†n th√†nh'; }

             if (isCorrect && currentQuestionIndex < quizData.length - 1 && autoAdvanceDuration > 0) {
                 timerBar.classList.add('timer-active');
                 autoAdvanceTimer = setTimeout(() => { autoAdvanceTimer = null; navigateNext(); }, autoAdvanceDuration);
             }
        }


        // --- Results/Restart/Review Functions ---
        // (showResults, restartQuiz, startReviewMode, exitReviewMode, toggleReviewFilter remain unchanged)
        function showResults() {
            console.log("[Mode] Showing Results");
            isReviewMode = false; reviewWrongOnly = false;
            clearAutoAdvanceTimer();
            quizSection.classList.add('hidden'); quizSection.style.display = 'none';
            resultsSection.classList.remove('hidden'); resultsSection.style.display = 'block';
            finalScoreText.textContent = `ƒêi·ªÉm cu·ªëi c√πng: ${score} / ${quizData.length}`;
            settingsMenu.classList.remove('menu-active'); settingsMenu.classList.add('hidden');
            settingsBtn.disabled = true; settingsBtn.style.opacity = '0.5'; settingsBtn.style.cursor = 'not-allowed';
        }
        function restartQuiz() {
            if (!quizData || quizData.length === 0) { showSelectScreen(); return; }
            console.log(`[Action] Restarting quiz: ${currentFileName}`);
            quizData = [...originalQuizData];
            if (shuffleCheckbox.checked) { shuffleArray(quizData); }
            startQuiz();
        }
        function startReviewMode() {
             if (!quizData || quizData.length === 0) return;
             console.log("[Mode] Entering Review Mode");
             wrongAnswerIndices = [];
             quizData.forEach((q, index) => {
                 const userAnswer = userAnswers[index];
                 if (userAnswer !== undefined && userAnswer !== q.correctAnswerIndex) { wrongAnswerIndices.push(index); }
             });
             console.log(`[Review Prep] Found ${wrongAnswerIndices.length} wrong answers.`);

             isReviewMode = true; reviewWrongOnly = false;
             currentQuestionIndex = 0;
             clearAutoAdvanceTimer(); updateTimerDisplayAndControls();

             resultsSection.classList.add('hidden'); resultsSection.style.display = 'none';
             quizSection.classList.remove('hidden'); quizSection.style.display = 'block';
             navControls.classList.add('hidden');
             reviewControls.classList.remove('hidden');

             displayQuestion(currentQuestionIndex);
        }
        function exitReviewMode() {
            console.log("[Mode] Exiting Review Mode");
            isReviewMode = false; reviewWrongOnly = false;
            currentWrongAnswerReviewIndex = 0;
            showResults();
        }
        function toggleReviewFilter() {
             if (!isReviewMode) return;
             reviewWrongOnly = !reviewWrongOnly;
             if (reviewWrongOnly) {
                 console.log("[Filter] Activating 'Wrong Only' filter.");
                 if (wrongAnswerIndices.length === 0) { alert("Ch√∫c m·ª´ng! B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£ c√°c c√¢u ƒë√£ l√†m."); reviewWrongOnly = false; return; }
                 currentWrongAnswerReviewIndex = 0;
                 currentQuestionIndex = wrongAnswerIndices[currentWrongAnswerReviewIndex];
             } else { console.log("[Filter] Deactivating 'Wrong Only' filter."); }
             displayQuestion(currentQuestionIndex);
         }


        // --- Utility Functions ---
        // (showError, hideError remain unchanged)
        function showError(message) { console.error("[UI Error]", message); errorMessage.textContent = message; errorMessage.classList.remove('hidden'); }
        function hideError() { errorMessage.textContent = ''; errorMessage.classList.add('hidden'); }

        // (showSelectScreen updated to ensure clean state)
        function showSelectScreen() {
            console.log("[UI Update] Returning to Select Screen");
            // Reset state variables
            originalQuizData = []; quizData = []; currentFileName = ""; score = 0; userAnswers = {}; questionsAnswered = {};
            currentQuestionIndex = 0; isReviewMode = false; reviewWrongOnly = false;
            clearAutoAdvanceTimer(); hideError();

            // Reset UI sections
            quizSection.classList.add('hidden'); quizSection.style.display = 'none';
            resultsSection.classList.add('hidden'); resultsSection.style.display = 'none';
            usageDetails.classList.remove('hidden'); // Show usage details again

            // Hide and clear the quiz title
            quizTitleElement.textContent = '';
            quizTitleElement.classList.add('hidden');

            // Show select section and enable controls
            selectSection.classList.remove('hidden'); selectSection.style.display = 'block';
            shuffleCheckbox.disabled = false;
            quizFileListContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);

            // Reset other UI elements
            statusMessage.textContent = ""; // Clear any loading/status messages
            errorMessage.textContent = ''; // Clear any previous error messages
            errorMessage.classList.add('hidden');
            settingsMenu.classList.remove('menu-active'); // Ensure settings menu is closed
            settingsMenu.classList.add('hidden');

            // Re-load the manifest to show quiz options
            loadQuizManifest();
        }


        // --- Run on script load ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("[Init] DOM Loaded.");
            applyInitialTheme();
            updateTimerDisplayAndControls();
            showSelectScreen(); // Start by showing the selection screen
            if (usageDetails.hasAttribute('open')) { usageDetails.open = true; }
        });

    </script>
</body>
</html>